void 0===Craft.Smith&&(Craft.Smith={}),function(t){Craft.Smith.Init=Garnish.Base.extend({init:function(i){for(var a=Garnish.$doc.find(".matrix-field"),e=0;e<a.length;e++)for(var n=t(a[e]),s=n.find("> .blocks > .matrixblock"),o=0;o<s.length;o++){var c=t(s[o]),r,l=c.find(".actions .settings.menubtn").data("menubtn")||!1;if(!l)return;new Craft.Smith.Menu(n,c,s,l)}Garnish.on(Craft.MatrixInput,"blockAdded",t.proxy(this,"blockAdded"))},blockAdded:function(i){Garnish.requestAnimationFrame(t.proxy((function(){var a=i.target.$container,e=a.find("> .blocks > .matrixblock"),n=t(i.$block),s,o=n.find(".actions .settings.menubtn").data("menubtn")||!1;o?new Craft.Smith.Menu(a,n,e,o):this.blockAdded(i)}),this))}}),Craft.Smith.Menu=Garnish.Base.extend({init:function(i,a,e,n){this.$matrixField=i,this.$matrixBlock=a,this.$matrixBlocks=e,this.menuBtn=n,this.menu=n.menu;var s=this.menu.$container.find('a[data-action="delete"]').parents("li");this.$copyBtn=t('<a data-icon="copy" data-action="copy">'+Craft.t("app","Copy")+"</a>"),this.$pasteBtn=t('<a data-icon="paste" data-action="paste">'+Craft.t("app","Paste")+"</a>"),this.$cloneBtn=t('<a data-icon="clone" data-action="clone">'+Craft.t("app","Clone")+"</a>"),this.$copyBtn.insertBefore(s).wrap("<li/>"),this.$pasteBtn.insertBefore(s).wrap("<li/>"),this.$cloneBtn.insertBefore(s).wrap("<li/>"),t('<hr class="padded">').insertBefore(s),this.menu.addOptions(this.$copyBtn),this.menu.addOptions(this.$pasteBtn),this.menu.addOptions(this.$cloneBtn),this.menu.on("optionselect",t.proxy(this,"onOptionSelect")),this.checkPaste()},onOptionSelect:function(i){var a=t(i.selectedOption);a.hasClass("disabled")||a.hasClass("sel")||("copy"==a.data("action")&&this.copyBlock(i),"paste"==a.data("action")&&this.pasteBlock(i),"clone"==a.data("action")&&this.cloneBlock(i))},checkPaste:function(){var t=!1;try{var i=JSON.parse(localStorage.getItem("smith:block")),a=this.$matrixField.attr("id").replace("fields-","");i&&i.field==a&&(t=!0)}catch(t){}t?this.$pasteBtn.enable():this.$pasteBtn.disable()},copyBlock:function(t){var i=this._serializeBlocks();localStorage.setItem("smith:block",JSON.stringify(i));var a=i.blocks.length,e=1==a?"1 block copied":"{n} blocks copied";Craft.cp.displayNotice(Craft.t("app",e,{n:a})),this.checkPaste()},pasteBlock:function(i,a){try{if(!a)var a=JSON.parse(localStorage.getItem("smith:block"));var e=this.$matrixField.find(".blocks"),n=t('<div class="spinner smith-spinner"></div>').insertAfter(this.$matrixBlock),s=this.$matrixField.data("matrix"),o=null;this.$matrixBlocks.each(t.proxy((function(i,a){if(this.$matrixBlock.data("id")==t(a).data("id")){var e=this.$matrixBlocks[i+1];if(e)return o=t(e)}}),this)),Craft.postActionRequest("smith/field/render-matrix-blocks",a,t.proxy((function(t,i){if("success"===i&&t.success)for(var a=0;a<t.blocks.length;a++){var e=t.blocks[a],c=s.blockTypesByHandle[e.typeHandle];s.blockTypesByHandle[e.typeHandle]=e;var r=s.addBlock(e.typeHandle,o);s.blockTypesByHandle[e.typeHandle]=c}n.remove()}),this))}catch(i){}},cloneBlock:function(t){var i=this._serializeBlocks();this.pasteBlock(t,i)},_serializeBlocks:function(){var t={field:"",blocks:[]},i,a=this.$matrixField.data("matrix").blockSelect.$selectedItems;a.length||(a=[this.$matrixBlock]);for(var e=0;e<a.length;e++){var n=a[e],s=Garnish.getPostData(n),o=Craft.expandPostArray(s);for(var c in o.fields)for(var r in t.field=c,o.fields[c].blocks){var l=o.fields[c].blocks[r];t.blocks.push(l)}}return t}})}(jQuery);
//# sourceMappingURL=smith.js.map