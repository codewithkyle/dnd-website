import{env as e}from"./env.mjs";import{hookup as t,message as n}from"./broadcaster.mjs";import{fetchCSS as s,fetchJS as o}from"./fetch.mjs";import{djinnjsOutDir as i,disablePjax as r,usePercentage as a}from"./config.mjs";export const runtime=new class{constructor(){this.handleLoadEvent=this.init.bind(this),this.intersectionCallback=this.handleIntersection.bind(this),this._bodyParserWorker=new Worker(`${window.location.origin}/${i}/runtime-worker.mjs`),this._loadingMessage=document.body.querySelector("djinnjs-file-loading-message")||null,this._loadingMessage&&this._loadingMessage.setAttribute("state","1"),window.addEventListener("load",this.handleLoadEvent)}init(){this._loadingMessage&&(this._loadingMessage.innerHTML="Collecting resources",this._loadingMessage.setAttribute("state","2")),t("runtime",this.inbox.bind(this)),this._bodyParserWorker.postMessage({type:"eager",body:document.body.innerHTML}),this._bodyParserWorker.onmessage=this.handleWorkerMessage.bind(this),this._io=new IntersectionObserver(this.intersectionCallback)}inbox(e){const{type:t}=e;switch(t){case"load":s(e.resources);break;case"mount-components":this.handleWebComponents();break;case"parse":this.parseHTML(e.body,e.requestUid);break;case"mount-inline-scripts":this.handleInlineScripts(e.selector);break;default:return}}handleWorkerMessage(t){const i=t.data;switch(i.type){case"eager":const t=document.body.querySelector("djinnjs-file-loading-value")||null;"hard-loading"===e.domState&&this._loadingMessage&&(this._loadingMessage.setAttribute("state","3"),this._loadingMessage.innerHTML="Loading resources:",t&&a?(t.innerHTML="0%",t.setAttribute("state","enabled")):t&&(t.innerHTML="0/"+i.files.length,t.setAttribute("state","enabled"))),s(i.files).then(()=>{e.setDOMState("idling"),this.handlePageScrollPosition(),this._bodyParserWorker.postMessage({type:"lazy",body:document.body.innerHTML})});break;case"lazy":s(i.files).then(()=>{this.handleWebComponents(),"2g"===e.connection||"slow-2g"===e.connection||r||o("pjax").then(()=>{n("pjax",{type:"init"},null,Infinity)}),n("runtime",{type:"completed"})});break;case"parse":this.fetchPjaxResources(i.pjaxFiles,i.requestUid);break;default:return}}handleInlineScripts(e){const t=document.body.querySelector(e);t&&t.querySelectorAll("script").forEach(e=>{const t=document.createElement("script");if(t.type=e.type,t.noModule=e.noModule,t.crossOrigin=e.crossOrigin,t.integrity=e.integrity,t.nonce=e.nonce,t.referrerPolicy=e.referrerPolicy,(null==e?void 0:e.src)||(null==e?void 0:e.id)||e.getAttribute("pjax-script-id")){let n="script";n+=`[src="${null==e?void 0:e.src}"]`||"#"+(null==e?void 0:e.id)||`[pjax-script-id="${e.getAttribute("pjax-script-id")}"]`;const s=document.head.querySelector(n);if(s){null===e.getAttribute("pjax-prevent-remount")&&(s.remove(),t.src=e.src,document.head.appendChild(t))}else t.src=e.src,document.head.appendChild(t)}else t.innerHTML=e.innerHTML,document.head.appendChild(t)})}handlePageScrollPosition(){if(window.location.hash){const e=document.body.querySelector(window.location.hash);if(e)return void e.scrollIntoView()}window.scrollTo(0,0)}fetchPjaxResources(e,t){s(e.eager).then(()=>{n("pjax",{type:"css-ready",requestUid:t}),s(e.lazy)})}parseHTML(e,t){this._bodyParserWorker.postMessage({type:"parse",body:e,requestUid:t})}upgradeToWebComponent(e,t){o(e).then(()=>{t.setAttribute("component-state","mounted")})}handleIntersection(e){for(let t=0;t<e.length;t++)if(e[t].isIntersecting){this._io.unobserve(e[t].target);const n=e[t].target.tagName.toLowerCase().trim();void 0===customElements.get(n)?this.upgradeToWebComponent(n,e[t].target):e[t].target.setAttribute("component-state","mounted")}}handleWebComponents(){const e=Array.from(document.body.querySelectorAll("[web-component]:not([component-state])"));for(let t=0;t<e.length;t++){const n=e[t];if("eager"===n.getAttribute("loading")){const e=n.tagName.toLowerCase().trim();this.upgradeToWebComponent(e,n)}else n.setAttribute("component-state","unseen"),this._io.observe(e[t])}}};