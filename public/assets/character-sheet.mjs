import{env as e}from"./env.mjs";import{message as t}from"./broadcaster.mjs";import{snackbar as s}from"./notifyjs.mjs";class l extends HTMLElement{constructor(){super(),this.switchView=e=>{const t=e.currentTarget,s=parseInt(t.value);for(let e=0;e<this.pages.length;e++)this.pages[e].style.display=e===s?"grid":"none";window.history.replaceState(null,null,`${location.origin}/character/${this.dataset.characterUid}/${t.dataset.slug}`)},this.handleCharacterSave=e=>{e.preventDefault(),this.saveCharacter(!0)},this.handleKeypress=e=>{e instanceof KeyboardEvent&&"s"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.saveCharacter(!0))},this.handleExit=()=>{const e=new FormData(this.form),t=this.querySelector("attack-component");e.append("fields[attacksAndSpells]",t.dumpAttacks());const s=this.querySelector("#cantrip-spellbook");e.append("fields[cantrips]",s.dumpData());const l=this.querySelector("#level-1-spellbook");e.append("fields[level1Spells]",l.dumpData());const a=this.querySelector("#level-2-spellbook");e.append("fields[level2Spells]",a.dumpData());const i=this.querySelector("#level-3-spellbook");e.append("fields[level3Spells]",i.dumpData());const o=this.querySelector("#level-4-spellbook");e.append("fields[level4Spells]",o.dumpData());const n=this.querySelector("#level-5-spellbook");e.append("fields[level5Spells]",n.dumpData());const r=this.querySelector("#level-6-spellbook");e.append("fields[level6Spells]",r.dumpData());const c=this.querySelector("#level-7-spellbook");e.append("fields[level7Spells]",c.dumpData());const p=this.querySelector("#level-8-spellbook");e.append("fields[level8Spells]",p.dumpData());const d=this.querySelector("#level-9-spellbook");e.append("fields[level9Spells]",d.dumpData());const h=this.getProficientSkills();for(const[t,s]of Object.entries(h))e.append(`fields[${t}Proficiency]`,""+s);navigator.sendBeacon(location.origin+"/actions/entries/save-entry",e)},this.isSaving=!1,this.pages=Array.from(this.querySelectorAll("form-page")),this.form=this.querySelector("form"),this.countdown=300}getProficientSkills(){const e={};return this.querySelectorAll('skill-table input[type="checkbox"]').forEach(t=>{t.checked?e[t.dataset.skill]=1:e[t.dataset.skill]=0}),e}async saveCharacter(t=!1){if(this.dataset.preventSave)return;if(this.isSaving)return;this.isSaving=!0;const l=new FormData(this.form),a=this.querySelector("attack-component");l.append("fields[attacksAndSpells]",a.dumpAttacks());const i=this.querySelector("#cantrip-spellbook");l.append("fields[cantrips]",i.dumpData());const o=this.querySelector("#level-1-spellbook");l.append("fields[level1Spells]",o.dumpData());const n=this.querySelector("#level-2-spellbook");l.append("fields[level2Spells]",n.dumpData());const r=this.querySelector("#level-3-spellbook");l.append("fields[level3Spells]",r.dumpData());const c=this.querySelector("#level-4-spellbook");l.append("fields[level4Spells]",c.dumpData());const p=this.querySelector("#level-5-spellbook");l.append("fields[level5Spells]",p.dumpData());const d=this.querySelector("#level-6-spellbook");l.append("fields[level6Spells]",d.dumpData());const h=this.querySelector("#level-7-spellbook");l.append("fields[level7Spells]",h.dumpData());const u=this.querySelector("#level-8-spellbook");l.append("fields[level8Spells]",u.dumpData());const v=this.querySelector("#level-9-spellbook");l.append("fields[level9Spells]",v.dumpData());const S=this.getProficientSkills();for(const[e,t]of Object.entries(S))l.append(`fields[${e}Proficiency]`,""+t);let m;t&&(m=e.startLoading());const f=await fetch(location.origin+"/actions/entries/save-entry",{method:"POST",body:l,headers:new Headers({Accept:"application/json"}),credentials:"include"});if(f.ok){(await f.json()).success}else{await f.text()}t&&(e.stopLoading(m),s({message:"Character saved.",force:!1,closeable:!0,duration:3})),this.countdown=300,this.isSaving=!1}autoSave(){const e=performance.now(),t=(e-this.time)/1e3;this.time=e,this.isSaving||(this.countdown-=t,this.countdown<=0&&this.isActive&&this.saveCharacter()),window.requestAnimationFrame(this.autoSave.bind(this))}disconnectedCallback(){this.isActive=!1,this.countdown=0,this.autoSave=()=>{},t("server",{type:"leave",campaign:this.dataset.campaignUid})}connectedCallback(){if(this.querySelectorAll("nav input").forEach(e=>{e.addEventListener("change",this.switchView)}),this.dataset.preventSave||!this.dataset.campaignUid||!this.dataset.characterName)return this.querySelectorAll("textarea, input").forEach(e=>{e.readOnly=!0}),void this.form.addEventListener("submit",e=>{e.preventDefault()});this.form.addEventListener("submit",this.handleCharacterSave),this.dataset.preventSave||(this.querySelector("#save-button").addEventListener("click",this.handleCharacterSave),document.addEventListener("keydown",this.handleKeypress),this.time=performance.now(),this.isActive=!0,this.autoSave(),window.addEventListener("unload",this.handleExit)),t("server",{type:"join",name:this.dataset.characterName,campaign:this.dataset.campaignUid,characterUid:this.dataset.characterUid})}}customElements.define("character-sheet",l);